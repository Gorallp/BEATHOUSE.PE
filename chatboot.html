<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Chatbot Simple - Beat House / SumapSeguros</title>
<style>
  :root{
    --bg:#f4f7fb; --card:#ffffff; --primary:#2f6fed; --muted:#68758a;
  }
  html,body{height:100%; margin:0; font-family:Inter,Segoe UI,Helvetica,Arial,sans-serif; background:var(--bg);}
  /* widget container */
  .chat-widget {
    position:fixed;
    right:20px;
    bottom:20px;
    width:360px;
    max-width:calc(100% - 40px);
    box-shadow:0 8px 30px rgba(31,41,51,.15);
    border-radius:12px;
    overflow:hidden;
    background:var(--card);
    display:flex;
    flex-direction:column;
  }
  .chat-header{
    background:linear-gradient(90deg,var(--primary),#4a86ff);
    color:#fff;
    padding:12px 14px;
    display:flex;
    gap:10px;
    align-items:center;
  }
  .chat-header h4{margin:0; font-size:15px;}
  .chat-body{
    height:420px;
    min-height:200px;
    overflow:auto;
    padding:14px;
    background:linear-gradient(180deg,#f7f9ff,#fff);
  }
  .msg {display:flex; gap:8px; margin-bottom:12px; align-items:flex-end;}
  .msg.bot {justify-content:flex-start;}
  .msg.user {justify-content:flex-end;}
  .avatar {
    width:36px;height:36px;border-radius:50%;flex:0 0 36px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;
  }
  .avatar.bot{background:#2f6fed;}
  .bubble {
    max-width:70%;
    padding:10px 12px;
    border-radius:12px;
    font-size:14px;
    line-height:1.3;
  }
  .bot .bubble {background:#eef6ff;color:#0a2b66;border-radius:12px 12px 12px 4px;}
  .user .bubble {background:var(--primary); color:#fff;border-radius:12px 12px 4px 12px;}
  .meta {font-size:11px;color:var(--muted);margin-top:4px;}
  .quick-replies {display:flex;flex-wrap:wrap;gap:8px;margin-top:8px;}
  .quick-replies button{background:#eef6ff;border:0;padding:6px 10px;border-radius:10px;color:#0a2b66;cursor:pointer;font-size:13px}
  .typing {font-style:italic;color:var(--muted); font-size:13px;}
  .chat-footer{display:flex;gap:8px;padding:10px;border-top:1px solid #eef1f6;align-items:center;}
  .chat-footer input{flex:1;padding:10px 12px;border-radius:10px;border:1px solid #e3e8ef; font-size:14px}
  .chat-footer button{background:var(--primary);color:#fff;border:0;padding:10px 14px;border-radius:10px;cursor:pointer}
  .small {font-size:12px;color:var(--muted);}
  /* mobile tweak */
  @media(max-width:420px){
    .chat-widget{right:10px;left:10px;width:auto;}
    .chat-body{height:60vh;}
  }
</style>
</head>
<body>

<!-- Chat widget -->
<div class="chat-widget" id="chatWidget" aria-live="polite">
  <div class="chat-header">
    <div style="display:flex;flex-direction:column;">
      <h4>Asistente Virtual</h4>
      <div class="small">Consulta precios, marcas y disponibilidad</div>
    </div>
  </div>

  <div class="chat-body" id="chatBody" role="log">
    <!-- messages inserted here -->
  </div>

  <div class="chat-footer" role="form" aria-label="Chat input">
    <input id="chatInput" type="text" placeholder="Escribe tu consulta (ej. Â¿CuÃ¡l es mi saldo?)" />
    <button id="sendBtn">Enviar</button>
  </div>
</div>

<script>
/* ---------------------------
  Chatbot simple basado en keywords
   - Guarda historial en localStorage
   - Simula "typing" y respuesta asincrÃ³nica
   - Hook: sendToBackend(message) -> Promise for real NLP
---------------------------- */
const chatBody = document.getElementById('chatBody');
const input = document.getElementById('chatInput');
const sendBtn = document.getElementById('sendBtn');

const DEFAULT_USER = {id:1, name: 'Usuario'};
const STORAGE_KEY = 'chatbot_demo_history_v1';

// util: scroll to bottom
function scrollBottom(){ chatBody.scrollTop = chatBody.scrollHeight; }

// render a message
function renderMessage(text, who='bot', meta=''){
  const wrapper = document.createElement('div');
  wrapper.className = 'msg ' + (who==='bot' ? 'bot' : 'user');
  const avatar = document.createElement('div');
  avatar.className = 'avatar ' + (who==='bot' ? 'bot' : 'user');
  avatar.textContent = (who==='bot' ? 'B' : 'T');
  const bubble = document.createElement('div');
  bubble.className = 'bubble';
  bubble.innerHTML = text;
  wrapper.appendChild(avatar);
  wrapper.appendChild(bubble);
  chatBody.appendChild(wrapper);
  if(meta){
    const m = document.createElement('div'); m.className='meta'; m.textContent = meta;
    chatBody.appendChild(m);
  }
  scrollBottom();
}

// render typing indicator
function renderTyping(){
  const t = document.createElement('div');
  t.className = 'msg bot typing';
  t.id = 'typingIndicator';
  t.innerHTML = `<div class="avatar bot">B</div><div class="bubble typing">Escribiendo...</div>`;
  chatBody.appendChild(t);
  scrollBottom();
}

// remove typing
function removeTyping(){
  const t = document.getElementById('typingIndicator');
  if(t) t.remove();
}

// save history (array of {who,text,ts})
function saveToHistory(entry){
  const h = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
  h.push(entry);
  localStorage.setItem(STORAGE_KEY, JSON.stringify(h));
}

// load history
function loadHistory(){
  const h = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
  h.forEach(e => renderMessage(e.text, e.who, new Date(e.ts).toLocaleString()));
}

// simple keyword-based intent classifier
function classifyIntent(text){
  text = text.toLowerCase();
  if(/hola|buenas|buenos|saludos/.test(text)) return 'greeting';
  if(/instrumento|stock|envio/.test(text)) return 'consulta_aportes';
  if(/Venta!auiler|como|como|cual|cuÃ¡l/.test(text)) return 'consulta_tipo';
  if(/nuevo|segunda mano|asegur|aseguradora|cobertura/.test(text)) return 'consulta_seguro';
  if(/cita|agendar|agenda|reservar/.test(text)) return 'agendar';
  if(/ayuda|soporte|problema|contacto/.test(text)) return 'soporte';
  if(/gracias|ok|perfecto|vale/.test(text)) return 'thanks';
  // fallback
  return 'unknown';
}

// canned responses
function generateResponse(intent, text){
  switch(intent){
    case 'greeting':
      return `Â¡Hola! ðŸ‘‹ Soy tu asistente virtual. Puedo ayudarte con consultas sobre aportes (ONP/AFP), pÃ³lizas y asesorÃ­a financiera. Â¿En quÃ© puedo ayudarte hoy?`;
    case 'consulta_aportes':
      // example: simulate retrieval
      return `He localizado tus Ãºltimos aportes: <ul><li>2024-01: S/. 150.00</li><li>2024-02: S/. 150.00</li><li>2024-03: S/. 150.00</li></ul>
              Saldo aproximado: <b>S/. 4,320.50</b>. Â¿Deseas una proyecciÃ³n de pensiÃ³n?`;
    case 'consulta_tipo':
      return `Puedo mostrarte diferencias entre ONP y AFP. En breve: <ul><li><b>ONP</b>: Sistema pÃºblico, pago a fondo comÃºn.</li><li><b>AFP</b>: Cuentas individuales, rentabilidad variable.</li></ul> Â¿Quieres comparar rentabilidades?`;
    case 'consulta_seguro':
      return `Â¿QuÃ© tipo de seguro te interesa? Puedo ayudarte con: vida, salud, vehicular o contra accidentes. TambiÃ©n puedo mostrar pÃ³lizas activas si estÃ¡s registrado.`;
    case 'agendar':
      return `Puedo agendar una cita con un asesor. IndÃ­came fecha aproximada y si prefieres atenciÃ³n presencial o virtual.`;
    case 'soporte':
      return `Para soporte humano, puedes escribirnos a soporte@ejemplo.com o llamar al 0800-XXX. Â¿Quieres que abra un ticket desde aquÃ­?`;
    case 'thanks':
      return `Â¡Con gusto! Si necesitas algo mÃ¡s, escrÃ­beme. ðŸ˜Š`;
    default:
      return `Lo siento, no entendÃ­ muy bien. Puedes preguntar por: "saldo", "seguros", "citas", "asistente humano" o "comparar AFP". Si quieres, puedo derivar tu consulta a un asesor.`;
  }
}

/* Simular envÃ­o a backend (hook)
   Reemplaza por fetch('/api/nlp', {method:'POST', body:{text}}) cuando tengas servidor.
   Debe devolver { intent, response }.
*/
function sendToBackendSim(text){
  return new Promise(resolve=>{
    // fake latency
    setTimeout(()=>{
      const intent = classifyIntent(text);
      const response = generateResponse(intent, text);
      resolve({ intent, response });
    }, 600 + Math.random()*600);
  });
}

/* main send flow */
async function sendMessage(rawText){
  const text = rawText && rawText.trim();
  if(!text) return;
  // render user
  renderMessage(text, 'user', new Date().toLocaleString());
  saveToHistory({who:'user', text, ts:Date.now()});

  input.value = '';
  // show typing
  renderTyping();

  // call backend (simulated)
  try {
    const { intent, response } = await sendToBackendSim(text);
    removeTyping();
    // render bot answer
    renderMessage(response, 'bot', new Date().toLocaleString());
    saveToHistory({who:'bot', text:response, ts:Date.now()});

    // if known intents, offer quick replies
    if(intent === 'consulta_aportes'){
      const qr = document.createElement('div');
      qr.className='quick-replies';
      qr.innerHTML = `
        <button onclick="quickReply('ProyecciÃ³n de pensiÃ³n')">ProyecciÃ³n</button>
        <button onclick="quickReply('Exportar aportes')">Exportar</button>
        <button onclick="quickReply('Hablar con asesor')">Asesor</button>
      `;
      chatBody.appendChild(qr); scrollBottom();
    } else if(intent === 'consulta_seguro'){
      const qr = document.createElement('div');
      qr.className='quick-replies';
      qr.innerHTML = `
        <button onclick="quickReply('Ver pÃ³lizas')">Ver pÃ³lizas</button>
        <button onclick="quickReply('Pagar prima')">Pagar prima</button>
        <button onclick="quickReply('Contactar aseguradora')">Contactar</button>
      `;
      chatBody.appendChild(qr); scrollBottom();
    }

  } catch(err){
    removeTyping();
    renderMessage('Disculpa, ocurriÃ³ un error tÃ©cnico. Intenta mÃ¡s tarde.', 'bot');
  }
}

// quick reply handler
function quickReply(text){
  sendMessage(text);
}

// keyboard & button
sendBtn.addEventListener('click', ()=> sendMessage(input.value));
input.addEventListener('keydown', (e) => { if(e.key === 'Enter') sendMessage(input.value); });

// load history if exists, else greet
loadHistory();
const history = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
if(history.length === 0){
  // initial greeting
  setTimeout(()=> sendMessage('hola'), 350);
}
</script>
</body>
</html>
